<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>基于websocket&#43;hyperf开发数据大屏系统 - 小叨笔记</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="小叨" /><meta name="description" content="背景 需要在大屏上展示订单趋势、订单国家、店铺数、商品排行、页面访问量等数据 选型 后端：hyperf 前端：react 后端 地图点亮订单国家城市点，" /><meta name="keywords" content="后端开发, PHP, Python, Golang, Linux Mysql Nginx Web开发技术, 生活感悟" />






<meta name="generator" content="Hugo 0.89.2 with theme even" />


<link rel="canonical" href="https://www.zouwan.top/post/ji-yu-websocket&#43;hyperf-kai-fa-shu-ju-da-ping-xi-tong/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="基于websocket&#43;hyperf开发数据大屏系统" />
<meta property="og:description" content="背景 需要在大屏上展示订单趋势、订单国家、店铺数、商品排行、页面访问量等数据 选型 后端：hyperf 前端：react 后端 地图点亮订单国家城市点，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.zouwan.top/post/ji-yu-websocket&#43;hyperf-kai-fa-shu-ju-da-ping-xi-tong/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-11-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-11-30T00:00:00+00:00" />

<meta itemprop="name" content="基于websocket&#43;hyperf开发数据大屏系统">
<meta itemprop="description" content="背景 需要在大屏上展示订单趋势、订单国家、店铺数、商品排行、页面访问量等数据 选型 后端：hyperf 前端：react 后端 地图点亮订单国家城市点，"><meta itemprop="datePublished" content="2021-11-30T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-11-30T00:00:00+00:00" />
<meta itemprop="wordCount" content="2940">
<meta itemprop="keywords" content="hyperf,websocket," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="基于websocket&#43;hyperf开发数据大屏系统"/>
<meta name="twitter:description" content="背景 需要在大屏上展示订单趋势、订单国家、店铺数、商品排行、页面访问量等数据 选型 后端：hyperf 前端：react 后端 地图点亮订单国家城市点，"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">小叨笔记</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">所有文章</li>
      </a><a href="/gopl-zh/">
        <li class="mobile-menu-item">Gopl Book</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于我</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">小叨笔记</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">所有文章</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/gopl-zh/">Gopl Book</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于我</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">基于websocket&#43;hyperf开发数据大屏系统</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-11-30 </span>
        <div class="post-category">
            <a href="/categories/web/"> web </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#背景">背景</a></li>
        <li><a href="#选型">选型</a>
          <ul>
            <li><a href="#后端">后端</a></li>
            <li><a href="#前端">前端</a></li>
          </ul>
        </li>
        <li><a href="#问题">问题</a>
          <ul>
            <li><a href="#wss连接的一些坑">wss连接的一些坑</a></li>
            <li><a href="#关于nginx中的websocket配置">关于Nginx中的WebSocket配置</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="背景">背景</h2>
<p>需要在大屏上展示订单趋势、订单国家、店铺数、商品排行、页面访问量等数据</p>
<h2 id="选型">选型</h2>
<ul>
<li>后端：hyperf</li>
<li>前端：react</li>
</ul>
<h3 id="后端">后端</h3>
<p>地图点亮订单国家城市点，使用 WebSocket 消息推送</p>
<blockquote>
<p>利用 WebSocket 协议让客户端和服务器端保持有状态的长链接，保存链接上来的客户端 id。订阅发布者发布的消息针对已保存的客户端 id 进行广播消息。</p>
</blockquote>
<p>WebSocket 服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">composer require hyperf/websocket-server
</code></pre></td></tr></table>
</div>
</div><p>配日志文件 <code>config/autoload/server.php</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="k">return</span> <span class="p">[</span>
    <span class="s1">&#39;mode&#39;</span> <span class="o">=&gt;</span> <span class="nx">SWOOLE_PROCESS</span><span class="p">,</span>
    <span class="s1">&#39;servers&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="nx">Server</span><span class="o">::</span><span class="na">SERVER_HTTP</span><span class="p">,</span>
            <span class="s1">&#39;host&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;port&#39;</span> <span class="o">=&gt;</span> <span class="mi">9508</span><span class="p">,</span>
            <span class="s1">&#39;sock_type&#39;</span> <span class="o">=&gt;</span> <span class="nx">SWOOLE_SOCK_TCP</span><span class="p">,</span>
            <span class="s1">&#39;callbacks&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="nx">SwooleEvent</span><span class="o">::</span><span class="na">ON_REQUEST</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">Hyperf\HttpServer\Server</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;onRequest&#39;</span><span class="p">],</span>
            <span class="p">],</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ws&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="nx">Server</span><span class="o">::</span><span class="na">SERVER_WEBSOCKET</span><span class="p">,</span>
            <span class="s1">&#39;host&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;port&#39;</span> <span class="o">=&gt;</span> <span class="mi">19508</span><span class="p">,</span>
            <span class="s1">&#39;sock_type&#39;</span> <span class="o">=&gt;</span> <span class="nx">SWOOLE_SOCK_TCP</span><span class="p">,</span>
            <span class="s1">&#39;callbacks&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="nx">SwooleEvent</span><span class="o">::</span><span class="na">ON_HAND_SHAKE</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">Hyperf\WebSocketServer\Server</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;onHandShake&#39;</span><span class="p">],</span>
                <span class="nx">SwooleEvent</span><span class="o">::</span><span class="na">ON_MESSAGE</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">Hyperf\WebSocketServer\Server</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;onMessage&#39;</span><span class="p">],</span>
                <span class="nx">SwooleEvent</span><span class="o">::</span><span class="na">ON_CLOSE</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">Hyperf\WebSocketServer\Server</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;onClose&#39;</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="s1">&#39;settings&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="c1">// &#39;open_websocket_ping_frame&#39; =&gt; true,
</span><span class="c1"></span>            <span class="p">]</span>
        <span class="p">],</span>
    <span class="p">],</span>
    <span class="s1">&#39;settings&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;enable_coroutine&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
        <span class="s1">&#39;worker_num&#39;</span> <span class="o">=&gt;</span> <span class="nx">swoole_cpu_num</span><span class="p">(),</span>
        <span class="s1">&#39;pid_file&#39;</span> <span class="o">=&gt;</span> <span class="nx">BASE_PATH</span> <span class="o">.</span> <span class="s1">&#39;/runtime/hyperf.pid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;open_tcp_nodelay&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
        <span class="s1">&#39;max_coroutine&#39;</span> <span class="o">=&gt;</span> <span class="mi">100000</span><span class="p">,</span>
        <span class="s1">&#39;open_http2_protocol&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
        <span class="s1">&#39;max_request&#39;</span> <span class="o">=&gt;</span> <span class="mi">100000</span><span class="p">,</span>
        <span class="s1">&#39;socket_buffer_size&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s1">&#39;buffer_output_size&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">&#39;callbacks&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="nx">SwooleEvent</span><span class="o">::</span><span class="na">ON_WORKER_START</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">Hyperf\Framework\Bootstrap\WorkerStartCallback</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;onWorkerStart&#39;</span><span class="p">],</span>
        <span class="nx">SwooleEvent</span><span class="o">::</span><span class="na">ON_PIPE_MESSAGE</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">Hyperf\Framework\Bootstrap\PipeMessageCallback</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;onPipeMessage&#39;</span><span class="p">],</span>
        <span class="nx">SwooleEvent</span><span class="o">::</span><span class="na">ON_WORKER_EXIT</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">Hyperf\Framework\Bootstrap\WorkerExitCallback</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;onWorkerExit&#39;</span><span class="p">],</span>
    <span class="p">],</span>
<span class="p">];</span>
</code></pre></td></tr></table>
</div>
</div><p>示例代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">declare</span><span class="p">(</span><span class="nx">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Hyperf\Contract\OnCloseInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Hyperf\Contract\OnMessageInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Hyperf\Contract\OnOpenInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Hyperf\Utils\ApplicationContext</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Swoole\Http\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Swoole\Server</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Swoole\Websocket\Frame</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Swoole\WebSocket\Server</span> <span class="k">as</span> <span class="nx">WebSocketServer</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">WebSocketController</span> <span class="k">implements</span> <span class="nx">OnMessageInterface</span><span class="p">,</span> <span class="nx">OnOpenInterface</span><span class="p">,</span> <span class="nx">OnCloseInterface</span>
<span class="p">{</span>

    <span class="k">protected</span> <span class="nv">$key</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$ttl</span> <span class="o">=</span> <span class="mi">7200</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$redis</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nx">ApplicationContext</span><span class="o">::</span><span class="na">getContainer</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Hyperf\Redis\Redis</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nx">config</span><span class="p">(</span><span class="s1">&#39;rdkey.ws_visited_client&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**
</span><span class="sd">     * 发送消息
</span><span class="sd">     * @param \Swoole\Http\Response|WebSocketServer $server
</span><span class="sd">     * @param Frame $frame
</span><span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">onMessage</span><span class="p">(</span><span class="nv">$server</span><span class="p">,</span> <span class="nx">Frame</span> <span class="nv">$frame</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="nv">$fdList</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">sMembers</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">);</span>
        <span class="c1">//如果当前客户端在客户端集合中,就刷新
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$frame</span><span class="o">-&gt;</span><span class="na">fd</span><span class="p">,</span> <span class="nv">$fdList</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">appendFd</span><span class="p">(</span><span class="nv">$frame</span><span class="o">-&gt;</span><span class="na">fd</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nv">$frame</span><span class="o">-&gt;</span><span class="na">fd</span><span class="p">,</span> <span class="s1">&#39;disconnect&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="sd">/**
</span><span class="sd">     * 客户端失去连接
</span><span class="sd">     * @param \Swoole\Http\Response|Server $server
</span><span class="sd">     * @param int $fd
</span><span class="sd">     * @param int $reactorId
</span><span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">onClose</span><span class="p">(</span><span class="nv">$server</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$fd</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$reactorId</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">sRem</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">);</span>
        <span class="c1">// var_dump(&#39;closed&#39;);
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="sd">/**
</span><span class="sd">     * 客户端连接
</span><span class="sd">     * @param \Swoole\Http\Response|WebSocketServer $server
</span><span class="sd">     * @param Request $request
</span><span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">onOpen</span><span class="p">(</span><span class="nv">$server</span><span class="p">,</span> <span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">appendFd</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">fd</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">fd</span><span class="p">,</span> <span class="s1">&#39;Opened Succeed&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$server</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">fd</span><span class="p">,</span> <span class="s1">&#39;Opened Failed&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="sd">/**
</span><span class="sd">     * 维护客户端
</span><span class="sd">     * @param $fd
</span><span class="sd">     * @return bool
</span><span class="sd">     */</span>
    <span class="k">private</span> <span class="k">function</span> <span class="nf">appendFd</span><span class="p">(</span><span class="nv">$fd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">sAdd</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$fd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redis</span><span class="o">-&gt;</span><span class="na">expire</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ttl</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>数据流转通道，订单数据地理信息、访问者地理信息</p>
<ul>
<li>AMQP 各系统流转方便</li>
<li>Redis 系统内部流转</li>
</ul>
<h3 id="前端">前端</h3>
<ul>
<li>每隔 5 秒钟发送一次心跳，避免 websocket 连接因超时而自动断开</li>
<li>错误捕获</li>
<li>连接断开，后端清理 <code>fd</code></li>
<li>获取经纬度数据后，点亮地图</li>
</ul>
<h2 id="问题">问题</h2>
<p>请求</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Request URL: wss://x.x.com/socket/
Request Method: GET
Status Code: 101 Switching Protocols
</code></pre></td></tr></table>
</div>
</div><p>Reponse Headers</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Connection: upgrade
Date: Thu, 05 Nov 2020 10:34:58 GMT
Sec-Websocket-Accept: Xxx2sQC8/ffwX+DoDNQDZ+MP70s=
Sec-Websocket-Version: 13
Server: nginx/1.18.0
Upgrade: websocket
</code></pre></td></tr></table>
</div>
</div><p>Request Headers</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cache-Control: no-cache
Connection: Upgrade
Host: x.x.com
Origin: https://x.x.com
Pragma: no-cache
Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits
Sec-WebSocket-Key: ssQ4Dv586zgMX4pji4SeNA==
Sec-WebSocket-Version: 13
Upgrade: websocket
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.183 Safari/537.36
</code></pre></td></tr></table>
</div>
</div><p><strong>问题1：websocket通信failed to execute &lsquo;send&rsquo;问题的解决</strong></p>
<p>浏览器Console报错：</p>
<p>InvalidStateError: Failed to execute &lsquo;send&rsquo; on &lsquo;WebSocket&rsquo;: Still in CONNECTING state.</p>
<p>要明白这个问题产生的原因，就需要了解websocket的几个状态。</p>
<p>通常在实例化一个websocket对象之后，客户端就会与服务器进行连接。但是连接的状态是不确定的，于是用readyState属性来进行标识。</p>
<p>它有四个值，分别对应不同的状态：</p>
<ul>
<li><code>CONNECTING</code> ：值为0，表示正在连接；</li>
<li><code>OPEN</code> ：值为1，表示连接成功，可以通信了；</li>
<li><code>CLOSING</code> ：值为2，表示连接正在关闭；</li>
<li><code>CLOSED</code> ：值为3，表示连接已经关闭，或者打开连接失败。</li>
</ul>
<p>这样问题的原因就很明显了，之所以数据不能发送出去，是因为websocket还处在“CONNECTING”状态下，连接还没有成功。</p>
<p><em>解决方案</em></p>
<p>只要在函数中添加对状态的判断，在状态为OPEN时，执行send方法即可。方法一代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="p">...</span>

<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&#34;ws://127.0.0.1:8000/ws&#34;</span><span class="p">);</span>

<span class="c1">//添加状态判断，当为OPEN时，发送消息
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">readyState</span><span class="o">===</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="c1">//do something
</span><span class="c1"></span><span class="p">}</span>

<span class="p">...</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>问题2：Error during WebSocket handshake: Unexpected response code: 200 错误解决</strong></p>
<p>拦截器的原因，经过反复查找并未发现拦截器有问题</p>
<p>报错的原因还是是拦截的问题，就是系统认证框架或者过滤器 拦截器等 对此访问连接进行了拦截导致，因此我们分析该问题的时候可以先将系统的所有可能拦截用户访问的组件全部关掉，再尝试一下，应该是可以访问成功的</p>
<p>我这里是 后台应用使用了JWT认证导致的，关闭后，handshake握手成功.</p>
<p>这里 我将websocket  连接添加到 JWT认证范围外，验证通过，完美解决</p>
<h3 id="wss连接的一些坑">wss连接的一些坑</h3>
<p>WebSocket 介绍</p>
<blockquote>
<p>以前，很多网站为了实现实时推送技术，所用的技术都是轮询。轮询是在特定的时间间隔（如每1秒），由浏览器对服务器发出HTTP请求，然后由服务器返回最新的数据给客户端。这种传统的模式带来的缺点很明显，即浏览器需要不断的向服务器发出请求，然而HTTP请求包含较多的请求头信息，而其中真正有效的数据只是很小的一部分，显然这样会浪费很多的带宽等资源。在这种情况下，HTML5定义了WebSocket协议，能更好的节省服务器资源和带宽，并且能够更实时地进行通讯。</p>
<blockquote>
<p>WebSocket是一种在单个TCP连接上进行全双工通讯的协议，使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在WebSocket API中，浏览器和服务器只需要完成一次握手，两者之间就可以创建持久性的连接，并进行双向数据传输。</p>
</blockquote>
</blockquote>
<p>HTTP、HTTPS、WS、WSS</p>
<ol>
<li>申领证书</li>
<li>配置https</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">server {
	#listen 80; #如果需要同时支持http和https
	listen 443 ssl http2;
	listen [::]:443 ssl http2;
	
	ssl_certificate &#34;/root/ssl/1_{域名}_bundle.crt&#34;;
	ssl_certificate_key &#34;/root/ssl/2_{域名}.key&#34;;
	ssl_session_cache shared:SSL:1m;
	ssl_session_timeout 10m;
	ssl_ciphers HIGH:!aNULL:!MD5;
	ssl_prefer_server_ciphers on;
	
	server_name {域名};
	
	location / {
		proxy_pass http://localhost:{代理端口};
	}
}
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>事故现场</li>
</ol>
<p>Mixed Content: The page at <code>https://{域名}.com/</code> was loaded over HTTPS, but attempted to connect to the insecure WebSocket endpoint <code>ws://{ip}:{port}/</code>. This request has been blocked; this endpoint must be available over WSS.</p>
<p>Uncaught DOMException: Failed to construct &lsquo;WebSocket&rsquo;: An insecure WebSocket connection may not be initiated from a page loaded over HTTPS.</p>
<p>WebSocket connection to <code>wss://{ip}:{port}/</code> failed: Error in connection establishment: net::ERR_SSL_PROTOCOL_ERROR</p>
<p>WebSocket connection to <code>wss://{域名}/</code> failed: Error during WebSocket handshake: Unexpected response code: 400</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">server {
	location / {
		proxy_pass http://localhost:{port};
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection &#34;upgrade&#34;;
	}
	
	location /socket/ {
		proxy_pass http://localhost:{port};
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection &#34;upgrade&#34;;
	}
}
</code></pre></td></tr></table>
</div>
</div><p><strong>注意</strong></p>
<p>代码路由需要接收对应的 <code>https://domain</code> 或 <code>https://domain/socket/</code></p>
<p>接着，连忙拿域名进行再次连接测试，终于看到了101 Switching Protocols的响应Status Code。就这样，也算是终于解决完在 HTTPS 下以 wss://{域名}/ 的方式连接 WebSocket的一系列问题。</p>
<h3 id="关于nginx中的websocket配置">关于Nginx中的WebSocket配置</h3>
<p>   自1.3 版本开始，Nginx就支持 WebSocket，并且可以为 WebSocket 应用程序做反向代理和负载均衡。WebSocket 和 HTTP 是两种不同的协议，但是 WebSocket 中的握手和 HTTP 中的握手兼容，它使用 HTTP 中的 Upgrade 协议头将连接从 HTTP 升级到 WebSocket，当客户端发过来一个 Connection: Upgrade请求头时，其实Nginx是不知道的。所以，当 Nginx 代理服务器拦截到一个客户端发来的 Upgrade 请求时，需要我们显式的配置Connection、Upgrade头信息，并使用 101（交换协议）返回响应，在客户端、代理服务器和后端应用服务之间建立隧道来支持 WebSocket。</p>
<p>   当然，还需要注意一点，此时WebSocket 仍然受到 Nginx 缺省为60秒的 <code>proxy_read_timeout</code> 配置影响。这意味着，如果你有一个程序使用了 WebSocket，但又可能超过60秒不发送任何数据的话，那么需要增大超时时间（配置<code>proxy_read_timeout</code>），要么实现一个Ping、Pong的心跳消息以保持客户端和服务端的联系。使用Ping、Pong的解决方法有额外的好处，如：可以发现连接是否被意外关闭等。
  </p>
<p>关于最后的这个小问题，主要是在对Nginx配置的时候将location=/的请求都进行了proxy_pass（转发）。由于h5客户端的文件打包成静态文件后，存放在服务器的指定目录下（这里假设在/root/html/static/路径下），这也就导致这种配置的情况下Nginx无法正常代理指定目录下的客户端文件。于是再一次修改配置文件，添加location配置，最终解决所有问题。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">location /static/ {
	root /root/html;
}
</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">小叨</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-11-30
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/hyperf/">hyperf</a>
          <a href="/tags/websocket/">websocket</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/life/tan-tui-xiu-sheng-huo/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">谈退休生活</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/wen-zhang-slug-sheng-cheng/">
            <span class="next-text nav-default">文章slug生成</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:whzywxt@163.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/whzywxt" class="iconfont icon-github" title="github"></a>
  <a href="https://www.zouwan.top/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  
  
  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2024<span class="heart"><i class="iconfont icon-heart"></i></span><span>小叨</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-156364991-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
